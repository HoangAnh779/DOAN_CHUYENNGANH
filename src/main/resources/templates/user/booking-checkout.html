<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="utf-8">
    <title>VIET NAM TRAVELER</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <meta content="Free HTML Templates" name="keywords">
    <meta content="Free HTML Templates" name="description">

    <!-- Favicon -->
    <link href="../../public/img/favicon.ico" rel="icon">

    <!-- Google Web Fonts -->
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css" rel="stylesheet">

    <!-- Libraries Stylesheet -->
    <link href="../../public/lib/owlcarousel/assets/owl.carousel.min.css" rel="stylesheet">
    <link href="../../public/lib/tempusdominus/css/tempusdominus-bootstrap-4.min.css" rel="stylesheet" />

    <!-- Customized Bootstrap Stylesheet -->
    <link href="../../public/css/style.css" rel="stylesheet">
</head>

<body>

    <!-- Topbar Start -->
    <div class="container-fluid bg-light pt-3 d-none d-lg-block">
        <div class="container">
            <div class="row">
                <div class="col-lg-6 text-center text-lg-left mb-2 mb-lg-0">
                    <div class="d-inline-flex align-items-center">
                        <p style="font-weight: 700;">
                            <i class="fa fa-phone-alt mr-2"></i>+84 968 1199 57
                        </p>
                        <a class="btn btn-primary py-1 px-2" href="/lien-he"
                            style="margin-top: -15px;margin-left: 20px;">Liên hệ ngay</a>
                    </div>
                </div>
                <div class="col-lg-6 text-center text-lg-right">
                    <div class="d-inline-flex align-items-center">
                        <a class="text-primary px-3" href="/account"> <i class="fa fa-user"></i>
                        </a> <a class="text-primary px-3" href="/logout"
                            onclick="return confirm('Bạn có chắc chắn đăng xuất');"> <i class="fas fa-sign-out-alt"></i>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Topbar End -->


    <!-- Navbar Start -->
    <div class="container-fluid position-relative nav-bar p-0">
        <div class="container-lg position-relative p-0 px-lg-3" style="z-index: 9;">
            <nav class="navbar navbar-expand-lg bg-light navbar-light shadow-lg py-3 py-lg-0 pl-3 pl-lg-5"
                style="border-radius:25px;">
                <a href="/" class="navbar-brand">
                    <h1 class="m-0 text-primary">
                        <img src="https://i.pinimg.com/originals/95/b2/2f/95b22f2e0059265d3d9cdb0cce0a4a27.png"
                            alt="Image" style="width: 117px;height: 74px;margin-left: 25px;">
                    </h1>
                </a>
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbarCollapse">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse justify-content-between px-3" id="navbarCollapse">
                    <div class="navbar-nav ml-auto py-0">
                        <a href="/" class="nav-item nav-link active">Trang chủ</a> <a href="/tour/trong-nuoc"
                            class="nav-item nav-link">Tour trong
                            nước</a> <a href="/tour/ngoai-nuoc" class="nav-item nav-link">Tour
                            ngoài nước</a> <a href="/tin-tuc" class="nav-item nav-link">Tin
                            tức</a> <a href="/lien-he" class="nav-item nav-link">Liên hệ</a> <a href="/account"
                            class="nav-item nav-link">Tài khoản</a>
                    </div>
                </div>
            </nav>
        </div>
    </div>

    <!-- Contact Start -->
    <div class="container-fluid py-5">
        <div class="container py-5">
            <div class="text-center mb-3 pb-3">
                <h1>Tiến hành đặt tour</h1>
                <h2 class="text-primary text-uppercase" style="letter-spacing: 5px;">Thông tin chi tiết</h2>
            </div>
            <div class="row justify-content-center">
                <div class="col-lg-8">
                    <div class="contact-form bg-white" style="padding: 30px; border-radius: 50px;">
                        <form name="sentMessage" method="post"
                            th:action="@{/tour/booking/{tour_id}(tour_id=${tour.id})}" id="contactForm"
                            novalidate="novalidate">
                            <h4 class="text-primary text-uppercase py-4" style="letter-spacing: 5px;">Thông tin Cá Nhân
                            </h4>
                            <div class="form-row">
                                <div class="control-group col-sm-6">
                                    <input type="text" class="form-control p-4" disabled="disabled" name="ho_ten"
                                        id="email" placeholder="Họ tên" th:value="${user.ho_ten}" required="required"
                                        data-validation-required-message="Vui lòng nhập họ và tên" />
                                    <p class="help-block text-danger"></p>
                                </div>
                                <div class="control-group col-sm-6">
                                    <input type="text" class="form-control p-4" id="name" disabled="disabled" name="sdt"
                                        placeholder="Số điện thoại liên hệ" required="required" th:value="${user.sdt}"
                                        data-validation-required-message="Vui lòng nhập số điện thoại" />
                                    <p class="help-block text-danger"></p>
                                </div>
                            </div>
                            <div class="control-group">
                                <input type="text" class="form-control p-4" name="dia_chi" id="subject"
                                    placeholder="Địa chỉ" required="required" disabled="disabled"
                                    th:value="${user.dia_chi}"
                                    data-validation-required-message="Vui lòng nhập địa chỉ" />
                                <p class="help-block text-danger"></p>
                            </div>
                            <div class="control-group">
                                <input type="email" class="form-control p-4" name="email" id="subjddect"
                                    placeholder="Email" required="required" disabled="disabled" th:value="${user.email}"
                                    data-validation-required-message="Vui lòng nhập email" />
                                <p class="help-block text-danger"></p>
                            </div>

                            <div class="control-group">
                                <h4 class="text-primary text-uppercase " style="letter-spacing: 5px;">Tên tour</h4>
                                <input type="email" class="form-control p-4" name="ten_tour" id="sddsbject"
                                    placeholder="Tên tour" required="required" disabled="disabled"
                                    data-validation-required-message="Vui lòng nhập email"
                                    th:value="${tour.ten_tour}" />
                                <p class="help-block text-danger"></p>
                            </div>

                            <div class="form-row">
                                <div class="control-group col-sm-6">
                                    <h4 class="text-primary text-uppercase " style="letter-spacing: 5px;">Ngày khởi hành
                                    </h4>
                                    <input type="tel" class="form-control p-4" id="namce" name="ngay_khoi_hanh"
                                        placeholder="Ngày khởi hành" required="required"
                                        th:value="${#dates.format(ngay_khoi_hanh, 'yyyy-MM-dd')}"
                                        data-validation-required-message="Vui lòng nhập số điện thoại" />
                                    <p class="help-block text-danger"></p>
                                </div>
                                <div class="control-group col-sm-6">
                                    <div class="mb-3 mb-md-0">
                                        <h4 class="text-primary text-uppercase " style="letter-spacing: 5px;">Số lượng
                                            người</h4>
                                        <input type="number" value="1" class="form-control p-4" th:value="${so_nguoi}"
                                            id="so_luong_nguoi" name="so_luong_nguoi" placeholder="Nhập số người" />
                                    </div>
                                </div>
                            </div>
                            <div class="control-group">
                                <h4 class="text-primary text-uppercase" style="letter-spacing: 5px;">Tổng tiền cần thanh
                                    toán</h4>
                                <h5 class="text-danger mt-4" id="tong_tien">
                                    [[${#numbers.formatInteger(tong_tien,3,'POINT')}]] VNĐ</h5>
                                <p class="help-block text-danger"></p>
                            </div>
                            <div class="control-group">
                                <h4 class="text-primary text-uppercase" style="letter-spacing: 5px;">Ghi chú</h4>
                                <textarea type="email" class="form-control p-4" name="ghi_chu" id="subjcdect"
                                    placeholder="Ghi chú" required="required"
                                    data-validation-required-message="Vui lòng nhập email"></textarea>
                                <p class="help-block text-danger"></p>
                            </div>
                            <h4 class="text-primary text-uppercase " style="letter-spacing: 5px;">Phương thức thanh toán
                            </h4>
                            <div class="form-row pb-2">
                                <div class="control-group">
                                    <input type="radio" value="0" checked class="p-2" id="tien_mat" name="pt_thanh_toan"
                                        placeholder="Ngày khởi hành" required="required" />
                                    <label for="tien_mat">Thanh toán tiền mặt tại công ty</label>
                                </div>
                                <div class="control-group">
                                    <input type="radio" value="1" class="p-2" id="chuyen_khoan" name="pt_thanh_toan"
                                        placeholder="Nhập số người" />
                                    <label for="chuyen_khoan">Chuyển khoản với nội dung: dattour_username_sdt đến stk:
                                        722039999979-MB bank </label>
                                </div>
                                <div class="control-group">
                                    <input type="radio" value="2" class="p-2" id="mo_mo" name="pt_thanh_toan"
                                        placeholder="Nhập số người" />
                                    <label for="mo_mo">Quét mã QR với nội dung: dattour_username_sdt </label>
                                </div>
                            </div>
                            <div class="text-center">
                                <button class="btn btn-primary py-3 px-4" type="submit" id="sendMessageButton">Xác nhận
                                    đặt tour</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Contact End -->

    <!-- Footer Start -->
    <div class="container-fluid bg-dark text-white-50 py-5 px-sm-3 px-lg-5" style="margin-top: 90px;">
        <div class="row pt-5">
            <div class="col-lg-4 col-md-6 mb-5">
                <a href="" class="navbar-brand">
                    <h1 class="text-primary">
                        <span class="text-white">VIET NAM</span> TOUR
                    </h1>
                </a>
                <p>Công ty dịch vụ du lịch và vận chuyển VIỆT NAM TOUR</p>
                <h2 class="text-white text-uppercase mt-4 mb-3" style="letter-spacing: 5px;">Theo dõi chúng tôi</h2>
                <div class="d-flex justify-content-start">
                    <a class="btn btn-outline-primary btn-square mr-2" href="#"><i class="fab fa-twitter"></i></a> <a
                        class="btn btn-outline-primary btn-square mr-2" href="#"><i class="fab fa-facebook-f"></i></a>
                    <a class="btn btn-outline-primary btn-square mr-2" href="#"><i class="fab fa-linkedin-in"></i></a>
                    <a class="btn btn-outline-primary btn-square" href="#"><i class="fab fa-instagram"></i></a>
                </div>
            </div>
            <div class="col-lg-4 col-md-6 mb-5">
                <h5 class="text-white text-uppercase mb-4" style="letter-spacing: 5px;">Dịch vụ của chúng tôi</h5>
                <div class="d-flex flex-column justify-content-start">
                    <a class="text-white-50 mb-2" href="#"><i class="fa fa-angle-right mr-2"></i>Về chúng tôi</a> <a
                        class="text-white-50 mb-2" href="#"><i class="fa fa-angle-right mr-2"></i>Đặt tour</a> <a
                        class="text-white-50 mb-2" href="#"><i class="fa fa-angle-right mr-2"></i>Liên hệ</a> <a
                        class="text-white-50 mb-2" href="#"><i class="fa fa-angle-right mr-2"></i>Tin tức</a>
                </div>
            </div>
            <div class="col-lg-4 col-md-6 mb-5">
                <h5 class="text-white text-uppercase mb-4" style="letter-spacing: 5px;">Liên hệ với chúng tôi</h5>
                <p>
                    <i class="fa fa-map-marker-alt mr-2"></i>10/80c Song Hành Xa Lộ Hà Nội, Phường Tân Phú, Quận 9, Hồ
                    Chí Minh
                </p>
                <p>
                    <i class="fa fa-phone-alt mr-2"></i>+84 968 1199 57
                </p>
                <p>
                    <i class="fa fa-envelope mr-2"></i>vietnamtour@hutech.com
                </p>
                <h6 class="text-white text-uppercase mt-4 mb-3" style="letter-spacing: 5px;">Bản Tin</h6>
                <div class="w-100">
                    <div class="input-group">
                        <input type="text" class="form-control border-light" style="padding: 25px;"
                            placeholder="Your Email">
                        <div class="input-group-append" style="margin: 0px 15px;">
                            <button class="btn btn-primary px-3">Đăng Kí</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer End -->




    <!-- Back to Top -->
    <a href="#" class="btn btn-lg btn-primary btn-lg-square back-to-top" style="border-radius:50%"><i
            class="fa fa-angle-double-up"></i></a>


    <!-- JavaScript Libraries -->
    <script src="/public/js/boostrap-bundle.min.js"></script>
    <script src="/public/js/jquery.js"></script>
    <script src="../../public/lib/easing/easing.min.js"></script>
    <script src="../../public/lib/owlcarousel/owl.carousel.min.js"></script>
    <script src="../../public/lib/tempusdominus/js/moment.min.js"></script>
    <script src="../../public/lib/tempusdominus/js/moment-timezone.min.js"></script>
    <script src="../../public/lib/tempusdominus/js/tempusdominus-bootstrap-4.min.js"></script>

    <!-- Contact Javascript File -->
    <script src="../../public/mail/jqBootstrapValidation.min.js"></script>

    <!-- Template Javascript -->
    <script src="../../public/js/main.js"></script>
    <script type="text/javascript">
        document.getElementById("sendMessageButton").addEventListener("click", function (event) {
            event.preventDefault(); // Ngăn chặn hành vi mặc định ban đầu

            document.addEventListener("DOMContentLoaded", function () {
                // Lấy tham số từ URL
                const urlParams = new URLSearchParams(window.location.search);
                const tongTienGiam = urlParams.get('tong_tien_giam');

                // Kiểm tra và cập nhật giá trị "Tổng tiền cần thanh toán"
                if (tongTienGiam) {
                    document.getElementById("tong_tien").innerHTML = `${parseInt(tongTienGiam).toLocaleString('vi-VN')} VNĐ`;
                } else {
                    console.warn("Không tìm thấy giá trị 'tong_tien_giam' trong URL.");
                }
            });

            // Lấy form và các giá trị từ URL
            const form = document.getElementById("contactForm");
            const formData = new FormData(form);

            const selectedPaymentMethod = document.querySelector('input[name="pt_thanh_toan"]:checked').value;
            const urlParams = new URLSearchParams(window.location.search);
            const tongTien = urlParams.get('tong_tien');
            const urlPath = window.location.pathname;
            const pathParts = urlPath.split('/');
            const tourId = pathParts[pathParts.length - 1];

            if (!tongTien || !tourId) {
                alert("Không tìm thấy thông tin cần thiết từ URL. Vui lòng kiểm tra lại.");
                return;
            }

            // Gửi dữ liệu lên server để lưu vào cơ sở dữ liệu
            fetch(form.action, {
                method: "POST",
                body: formData,
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error("Lỗi khi lưu dữ liệu. Vui lòng thử lại.");
                    }
                    return response.text(); // Hoặc JSON nếu cần
                })
                .then(data => {
                    console.log("Lưu dữ liệu thành công:", data);

                    // Nếu phương thức thanh toán là MoMo, chuyển hướng
                    if (selectedPaymentMethod === "2") {
                        const redirectUrl = `/momo/${tourId}?tong_tien=${tongTien}`;
                        console.log("Chuyển hướng tới:", redirectUrl);
                        window.location.href = redirectUrl;
                    } else {
                        // Với các phương thức khác, thực hiện hành vi mặc định (form submit)
                        form.submit();
                    }
                })
                .catch(error => {
                    console.error("Có lỗi xảy ra:", error);
                    alert("Không thể hoàn tất đặt tour. Vui lòng thử lại sau.");
                });
        });

    </script>
</body>

</html>